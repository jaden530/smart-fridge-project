<!-- Avatar Component - Animated 2D Character -->
<div id="avatar-container">
    <div class="avatar-wrapper">
        <!-- Avatar Character -->
        <svg id="avatar-svg" viewBox="0 0 200 300" xmlns="http://www.w3.org/2000/svg">
            <!-- Body -->
            <ellipse id="avatar-body" cx="100" cy="220" rx="60" ry="70" fill="#667eea" opacity="0.8"/>

            <!-- Head -->
            <circle id="avatar-head" cx="100" cy="100" r="60" fill="#764ba2"/>

            <!-- Eyes Container (for tracking) -->
            <g id="eyes-container">
                <!-- Left Eye -->
                <ellipse class="eye-white" cx="80" cy="90" rx="12" ry="15" fill="white"/>
                <circle class="pupil left-pupil" cx="80" cy="92" r="6" fill="#333"/>
                <circle class="eye-shine" cx="83" cy="89" r="3" fill="white" opacity="0.8"/>

                <!-- Right Eye -->
                <ellipse class="eye-white" cx="120" cy="90" rx="12" ry="15" fill="white"/>
                <circle class="pupil right-pupil" cx="120" cy="92" r="6" fill="#333"/>
                <circle class="eye-shine" cx="123" cy="89" r="3" fill="white" opacity="0.8"/>
            </g>

            <!-- Eyebrows -->
            <path id="left-eyebrow" d="M 70 75 Q 80 72 90 75" stroke="#333" stroke-width="3" fill="none" stroke-linecap="round"/>
            <path id="right-eyebrow" d="M 110 75 Q 120 72 130 75" stroke="#333" stroke-width="3" fill="none" stroke-linecap="round"/>

            <!-- Mouth -->
            <path id="avatar-mouth" d="M 80 120 Q 100 130 120 120" stroke="#333" stroke-width="3" fill="none" stroke-linecap="round"/>

            <!-- Arms (for gestures) -->
            <line id="left-arm" x1="50" y1="200" x2="30" y2="220" stroke="#667eea" stroke-width="12" stroke-linecap="round"/>
            <line id="right-arm" x1="150" y1="200" x2="170" y2="220" stroke="#667eea" stroke-width="12" stroke-linecap="round"/>
        </svg>

        <!-- Speech Bubble -->
        <div id="speech-bubble" class="speech-bubble hidden">
            <div class="bubble-content">
                <p id="speech-text"></p>
            </div>
            <div class="bubble-tail"></div>
        </div>
    </div>
</div>

<style>
#avatar-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 250px;
    height: 400px;
    z-index: 1000;
    pointer-events: none;
}

.avatar-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
}

#avatar-svg {
    width: 100%;
    height: 100%;
    filter: drop-shadow(0 10px 20px rgba(0,0,0,0.2));
}

/* Speech Bubble */
.speech-bubble {
    position: absolute;
    top: 0;
    left: -320px;
    width: 300px;
    background: white;
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    animation: bubbleFadeIn 0.3s ease;
}

.speech-bubble.hidden {
    display: none;
}

.bubble-content p {
    margin: 0;
    font-size: 16px;
    color: #333;
    line-height: 1.5;
}

.bubble-tail {
    position: absolute;
    right: -15px;
    top: 50%;
    width: 0;
    height: 0;
    border-left: 20px solid white;
    border-top: 15px solid transparent;
    border-bottom: 15px solid transparent;
    transform: translateY(-50%);
}

/* Animations */
@keyframes bubbleFadeIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes float {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
}

@keyframes blink {
    0%, 90%, 100% {
        transform: scaleY(1);
    }
    95% {
        transform: scaleY(0.1);
    }
}

@keyframes talking {
    0%, 100% {
        d: path("M 80 120 Q 100 130 120 120");
    }
    25% {
        d: path("M 80 120 Q 100 125 120 120");
    }
    50% {
        d: path("M 80 120 Q 100 135 120 120");
    }
    75% {
        d: path("M 80 120 Q 100 125 120 120");
    }
}

@keyframes wave {
    0%, 100% {
        transform: rotate(0deg);
        transform-origin: 170px 220px;
    }
    25% {
        transform: rotate(-30deg);
        transform-origin: 170px 220px;
    }
    75% {
        transform: rotate(30deg);
        transform-origin: 170px 220px;
    }
}

@keyframes nod {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(5px);
    }
}

@keyframes shake {
    0%, 100% {
        transform: translateX(0);
    }
    25%, 75% {
        transform: translateX(-5px);
    }
    50% {
        transform: translateX(5px);
    }
}

/* Emotion States */
.emotion-happy #avatar-mouth {
    d: path("M 80 115 Q 100 135 120 115");
}

.emotion-excited #avatar-mouth {
    d: path("M 80 115 Q 100 140 120 115");
}

.emotion-concerned #avatar-mouth {
    d: path("M 80 125 Q 100 115 120 125");
}

.emotion-surprised #avatar-mouth {
    d: path("M 90 120 L 110 120");
}

.emotion-thinking #left-eyebrow {
    d: path("M 70 70 Q 80 65 90 70");
}

/* Animation States */
.animation-idle #avatar-body {
    animation: float 3s ease-in-out infinite;
}

.animation-idle .eye-white {
    animation: blink 4s infinite;
}

.animation-talking #avatar-mouth {
    animation: talking 0.5s infinite;
}

.animation-waving #right-arm {
    animation: wave 1s ease-in-out 3;
}

.animation-nodding #avatar-head {
    animation: nod 0.5s ease-in-out 3;
}

.animation-shaking_head #avatar-head {
    animation: shake 0.5s ease-in-out 3;
}

.animation-pointing_right #right-arm {
    transform: rotate(-45deg);
    transform-origin: 150px 200px;
    transition: transform 0.3s ease;
}

.animation-pointing_left #left-arm {
    transform: rotate(45deg);
    transform-origin: 50px 200px;
    transition: transform 0.3s ease;
}

/* Mobile Optimization */
@media (max-width: 768px) {
    #avatar-container {
        bottom: 10px;
        right: 10px;
        width: 150px;
        height: 250px;
    }

    .speech-bubble {
        left: -220px;
        width: 200px;
        padding: 15px;
        font-size: 14px;
    }
}
</style>

<script>
class AvatarController {
    constructor() {
        this.container = document.getElementById('avatar-container');
        this.speechBubble = document.getElementById('speech-bubble');
        this.speechText = document.getElementById('speech-text');
        this.currentEmotion = 'neutral';
        this.currentAnimation = 'idle';
        this.eyeTrackingEnabled = true;

        this.init();
    }

    init() {
        // Start idle animation
        this.setAnimation('idle');

        // Setup eye tracking (follows mouse/touch)
        if (this.eyeTrackingEnabled) {
            this.setupEyeTracking();
        }

        // Auto-blink
        this.startBlinking();
    }

    setupEyeTracking() {
        document.addEventListener('mousemove', (e) => {
            this.updateEyePosition(e.clientX, e.clientY);
        });

        document.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            this.updateEyePosition(touch.clientX, touch.clientY);
        });
    }

    updateEyePosition(x, y) {
        const container = this.container.getBoundingClientRect();
        const centerX = container.left + container.width / 2;
        const centerY = container.top + 100; // Eye level

        // Calculate angle and distance
        const dx = x - centerX;
        const dy = y - centerY;
        const angle = Math.atan2(dy, dx);
        const distance = Math.min(Math.sqrt(dx * dx + dy * dy) / 100, 3);

        // Move pupils
        const offsetX = Math.cos(angle) * distance;
        const offsetY = Math.sin(angle) * distance;

        const leftPupil = document.querySelector('.left-pupil');
        const rightPupil = document.querySelector('.right-pupil');

        if (leftPupil && rightPupil) {
            leftPupil.setAttribute('cx', 80 + offsetX);
            leftPupil.setAttribute('cy', 92 + offsetY);
            rightPupil.setAttribute('cx', 120 + offsetX);
            rightPupil.setAttribute('cy', 92 + offsetY);
        }
    }

    startBlinking() {
        // Random blinks
        setInterval(() => {
            if (Math.random() < 0.1) {
                this.blink();
            }
        }, 1000);
    }

    blink() {
        const eyes = document.querySelectorAll('.eye-white');
        eyes.forEach(eye => {
            eye.style.animation = 'blink 0.15s';
            setTimeout(() => {
                eye.style.animation = '';
            }, 150);
        });
    }

    setEmotion(emotion) {
        // Remove previous emotion class
        this.container.classList.remove(`emotion-${this.currentEmotion}`);

        // Add new emotion class
        this.container.classList.add(`emotion-${emotion}`);
        this.currentEmotion = emotion;
    }

    setAnimation(animation) {
        // Remove previous animation class
        this.container.classList.remove(`animation-${this.currentAnimation}`);

        // Add new animation class
        this.container.classList.add(`animation-${animation}`);
        this.currentAnimation = animation;
    }

    speak(message, emotion = 'neutral', duration = 3000) {
        this.setEmotion(emotion);
        this.setAnimation('talking');

        // Show speech bubble
        this.speechText.textContent = message;
        this.speechBubble.classList.remove('hidden');

        // Auto-hide after duration
        setTimeout(() => {
            this.speechBubble.classList.add('hidden');
            this.setAnimation('idle');
        }, duration);
    }

    greet(userName, timeOfDay) {
        const greetings = {
            morning: `Good morning, ${userName}! â˜€ï¸`,
            afternoon: `Hey ${userName}! ðŸ‘‹`,
            evening: `Good evening, ${userName}!`,
            night: `Hey ${userName}, midnight snack?`
        };

        const message = greetings[timeOfDay] || `Hi ${userName}!`;

        this.setAnimation('waving');
        this.setEmotion('happy');

        setTimeout(() => {
            this.speak(message, 'happy', 4000);
        }, 500);
    }

    respondToAction(actionType, context) {
        const responses = {
            item_added: `Added ${context.item} to your inventory!`,
            item_removed: `Enjoy your ${context.item}!`,
            expiring_soon: `âš ï¸ Your ${context.item} expires in ${context.days} days!`,
            low_confidence: `Was that ${context.item}? I'm not sure...`
        };

        const message = responses[actionType] || 'Got it!';
        const emotion = actionType === 'expiring_soon' ? 'concerned' : 'happy';

        this.speak(message, emotion);
    }

    pointAt(direction) {
        this.setAnimation(`pointing_${direction}`);
        setTimeout(() => {
            this.setAnimation('idle');
        }, 2000);
    }

    think(message = "Let me think...") {
        this.setEmotion('thinking');
        this.speak(message, 'thinking', 2000);
    }

    updateState(state) {
        // Update from backend state
        this.setEmotion(state.emotion);
        this.setAnimation(state.animation);

        if (state.message && state.is_speaking) {
            this.speak(state.message, state.emotion);
        }

        if (state.eye_position) {
            // Manual eye position override
            const [x, y] = state.eye_position;
            // Convert normalized coords to pixel positions
            // (implementation depends on your coordinate system)
        }
    }
}

// Initialize avatar when DOM is ready
let avatar;
document.addEventListener('DOMContentLoaded', () => {
    avatar = new AvatarController();

    // Make globally accessible
    window.avatar = avatar;
});
</script>
